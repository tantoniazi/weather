<% content_for :title, "Relatórios de Clima" %>

<div class="container mt-5">
  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line"></i> Relatórios de Clima</h2>
        <%= link_to "Voltar", root_path, class: "btn btn-secondary" %>
      </div>

      <!-- Filtros -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-filter"></i> Filtros</h5>
        </div>
        <div class="card-body">
          <%= form_with url: reports_path, method: :get, local: true, class: "row g-3" do |form| %>
            <div class="col-md-4">
              <%= form.label :zip_code, "CEP", class: "form-label" %>
              <%= form.text_field :zip_code,
                                  value: params[:zip_code],
                                  placeholder: "Digite o CEP",
                                  class: "form-control" %>
            </div>
            
            <div class="col-md-3">
              <%= form.label :created_at_start, "Data Início", class: "form-label" %>
              <%= form.date_field :created_at_start,
                                  value: params[:created_at_start],
                                  class: "form-control" %>
            </div>
            
            <div class="col-md-3">
              <%= form.label :created_at_end, "Data Fim", class: "form-label" %>
              <%= form.date_field :created_at_end,
                                  value: params[:created_at_end],
                                  class: "form-control" %>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
              <%= form.submit "Filtrar", class: "btn btn-primary me-2" %>
              <%= link_to "Limpar", reports_path, class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Botões de Export -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-download"></i> Exportar Relatório</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Total de registros encontrados: <strong><%= @total_count %></strong></p>
          
          <%= form_with url: export_reports_path, method: :post, local: true, class: "mb-3" do |form| %>
            <%= form.hidden_field :zip_code, value: params[:zip_code] %>
            <%= form.hidden_field :created_at_start, value: params[:created_at_start] %>
            <%= form.hidden_field :created_at_end, value: params[:created_at_end] %>
            
            <div class="form-check mb-3">
              <%= form.check_box :email_notification, class: "form-check-input" %>
              <%= form.label :email_notification, "Receber notificação por email quando o relatório estiver pronto", class: "form-check-label" %>
            </div>
            
            <div class="btn-group" role="group">
              <%= form.submit "Exportar CSV", name: "format", value: "csv", class: "btn btn-success" %>
              <%= form.submit "Exportar Excel", name: "format", value: "xlsx", class: "btn btn-primary" %>
              <%= form.submit "Exportar PDF", name: "format", value: "pdf", class: "btn btn-danger" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Relatórios Recentes -->
      <% if @reports.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-history"></i> Relatórios Recentes</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Formato</th>
                    <th>Status</th>
                    <th>Criado em</th>
                    <th>Tamanho</th>
                    <th>Tempo</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% @reports.each do |report| %>
                    <tr>
                      <td>
                        <span class="badge bg-<%= case report.format
                                                  when "csv" then "success"
                                                  when "xlsx" then "primary"
                                                  when "pdf" then "danger"
                                                  end %>">
                          <%= report.format.upcase %>
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-<%= case report.status
                                                  when "pending" then "warning"
                                                  when "processing" then "info"
                                                  when "completed" then "success"
                                                  when "failed" then "danger"
                                                  end %>">
                          <%= report.status.humanize %>
                        </span>
                      </td>
                      <td>
                        <small><%= report.created_at.strftime("%d/%m/%Y %H:%M") %></small>
                      </td>
                      <td>
                        <small><%= report.file_size_human %></small>
                      </td>
                      <td>
                        <small><%= report.processing_time_human %></small>
                      </td>
                      <td>
                        <% if report.completed? %>
                          <%= link_to "Download", download_report_path(report), class: "btn btn-sm btn-outline-primary" %>
                        <% elsif report.failed? %>
                          <small class="text-danger" title="<%= report.error_message %>">Erro</small>
                        <% else %>
                          <small class="text-muted">Processando...</small>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <!-- Paginação dos relatórios -->
            <div class="d-flex justify-content-center mt-3">
              <%= paginate @reports, param_name: :reports_page %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Tabela de Dados -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-table"></i> Dados do Relatório</h5>
        </div>
        <div class="card-body">
          <% if @weathers.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>CEP</th>
                    <th>Temperatura</th>
                    <th>Temp. Mín</th>
                    <th>Temp. Máx</th>
                    <th>Descrição</th>
                    <th>Data/Hora</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% @weathers.each do |weather| %>
                    <tr>
                      <td><%= weather.zip_code %></td>
                      <td>
                        <span class="badge bg-primary">
                          <%= weather.temperature %>°C
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-info">
                          <%= weather.temp_min %>°C
                        </span>
                      </td>
                      <td>
                        <span class="badge bg-warning">
                          <%= weather.temp_max %>°C
                        </span>
                      </td>
                      <td>
                        <span class="text-capitalize">
                          <%= weather.description %>
                        </span>
                      </td>
                      <td>
                        <small>
                          <%= weather.created_at.strftime("%d/%m/%Y %H:%M") %>
                        </small>
                      </td>
                      <td>
                        <%= link_to "Ver", weather, class: "btn btn-sm btn-outline-primary" %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <!-- Paginação -->
            <div class="d-flex justify-content-center mt-4">
              <%= paginate @weathers %>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-search fa-3x text-muted mb-3"></i>
              <h4>Nenhum registro encontrado</h4>
              <p class="text-muted">Tente ajustar os filtros ou faça uma nova busca de clima.</p>
              <%= link_to "Buscar Clima", root_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.card {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: none;
  margin-bottom: 1.5rem;
}

.table th {
  border-top: none;
}

.btn-group .btn {
  margin-right: 0.5rem;
}

.badge {
  font-size: 0.9em;
}

@media (max-width: 768px) {
  .btn-group {
    flex-direction: column;
  }
  
  .btn-group .btn {
    margin-bottom: 0.5rem;
    margin-right: 0;
  }
}</style>
